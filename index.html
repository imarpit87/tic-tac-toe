<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tic Tac Toe - Multiplayer Game</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script>
    // Your firebase-config.js contents inline (replace placeholders)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>
  <style>
    /* ... your existing CSS (omitted for brevity) ... */
  </style>
</head>
<body>
  <!-- ... your existing HTML pages ... -->

  <script>
    // === First (and only) multiplayer implementation ===
    let roomRef, playerId, windowPlayerSymbol;
    function createRealTimeRoom() {
      if (!window.playerName || !window.selectedAvatar) {
        alert('Enter name and avatar!');
        return;
      }
      const code = Math.random().toString(36).substring(2,8).toUpperCase();
      window.roomCode = code;
      playerId = 'player1';
      roomRef = database.ref(`rooms/${code}`);
      const init = {
        code,
        board: Array(9).fill(null),
        currentPlayer: 'X',
        gameOver: false,
        players: {
          player1: { name: window.playerName, avatar: getAvatarEmoji(window.selectedAvatar), symbol: 'X', online: true }
        }
      };
      roomRef.set(init);
      setupRoomListeners();
      displayRoomCode.textContent = code;
      roomInfo.style.display = 'block';
      roomStatus.textContent = 'Waiting for friend...';
    }

    function joinRealTimeRoom() {
      if (!window.playerName || !window.selectedAvatar) {
        alert('Enter name and avatar!');
        return;
      }
      const code = roomCodeInput.value.trim().toUpperCase();
      if (code.length !== 6) { alert('Invalid code'); return; }
      window.roomCode = code;
      playerId = 'player2';
      roomRef = database.ref(`rooms/${code}`);
      roomRef.once('value').then(snap => {
        const data = snap.val();
        if (!data || data.players.player2) { alert('Cannot join'); return; }
        roomRef.child('players/player2').set({
          name: window.playerName,
          avatar: getAvatarEmoji(window.selectedAvatar),
          symbol: 'O',
          online: true
        });
        roomRef.child('currentPlayer').set(data.status === 'waiting' ? 'X' : data.currentPlayer);
        setupRoomListeners();
        displayRoomCode.textContent = code;
        roomInfo.style.display = 'block';
        roomStatus.textContent = 'Joined!';
      });
    }

    function setupRoomListeners() {
      roomRef.on('value', snap => {
        const data = snap.val();
        if (!data) return;
        board = data.board;
        currentPlayer = data.currentPlayer;
        gameOver = data.gameOver;
        updatePlayerDisplay(data.players);
        renderBoard();
        if (data.players.player1 && data.players.player2) {
          roomStatus.textContent = `${currentPlayer === 'X' ? data.players.player1.name : data.players.player2.name}'s turn`;
        }
        if (gameOver) {
          // handle win/draw popup
        }
      });
    }

    function makeRealTimeMove(idx) {
      roomRef.once('value').then(snap => {
        const data = snap.val();
        if (data.currentPlayer !== data.players[playerId].symbol) return;
        if (data.board[idx] !== null) return;
        const newBoard = [...data.board];
        newBoard[idx] = data.players[playerId].symbol;
        const next = data.players[playerId].symbol === 'X' ? 'O' : 'X';
        roomRef.update({ board: newBoard, currentPlayer: next });
      });
    }

    // In handleClick, call makeRealTimeMove(index) when multiplayerGame is true

    // Remove all bottom duplicate implementations (from second createRealTimeRoom() onward)
    // Keep only one set above.
  </script>
</body>
</html>
